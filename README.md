# PingTest Backend

## Лабораторная работа 1

### Дизайн
- Разработан дизайн трех страниц приложения в Figma
- Стилистика скопирована с существующего ресурса (3 цвета с точными кодами, hover-эффекты, форма карточек)
- CSS вынесен в отдельные файлы: `styles.css`, `details-styles.css`, `ping-time-styles.css`

### Шаблонизация
- Реализованы три страницы на Thymeleaf:
  - Главная страница со списком компонентов сервера (`main-page/main.html`)
  - Страница детального просмотра компонента (`details-page/component-detailed.html`)
  - Страница просмотра заявки времени отклика (`ping-time-page/ping-time.html`)
- Страница списка услуг отображает карточки в виде плитки с наименованием, временем отклика и изображением
- Реализована карточка текущей заявки с указанием количества услуг
- Добавлено поле поиска для фильтрации компонентов по наименованию
- Поле поиска сохраняется после запроса
- В header добавлена кнопка навигации на главную страницу

### Minio
- Настроена интеграция с Minio для хранения изображений
- Изображения загружаются и отображаются на всех трех страницах
- Генерация presigned URL для доступа к изображениям
- Наименование изображения указано ключом на латинице, хранится в модели отдельным полем

### Роутинг
- Реализованы три GET-запроса:
  - `GET /` - главная страница со списком компонентов
  - `GET /server-component/{id}` - страница детального просмотра компонента
  - `GET /ping-time/{id}` - страница просмотра заявки
- Фильтрация компонентов реализована на сервере через параметр `filter`

## Лабораторная работа 2

### База данных
- Создана структура БД PostgreSQL с 4 таблицами:
  - `server_components` - компоненты сервера (услуги)
  - `ping_times` - заявки времени отклика
  - `ping_time_components` - связь многие-ко-многим между заявками и компонентами
  - `users` - пользователи системы
- Реализованы связи между таблицами с внешними ключами
- Каскадное удаление запрещено

### Модели данных
- `ServerComponent`: id, title, description, longDescription, time, image, status, isDataBaseUsage
- `PingTime`: id, status, createdAt, creator, formationDate, completionDate, moderator, totalTime, loadCoefficient
- `PingTimeComponent`: составной ключ (pingTimeId, componentId), quantity
- `User`: id, username, password, role, isModerator, preferences

### Статусы заявок
- DRAFT - черновик
- DELETED - удален
- FORMED - сформирован
- COMPLETED - завершен
- REJECTED - отклонен
- ARCHIVED - архивирован

### ORM операции
- Получение и поиск компонентов через JPA Repository
- Добавление компонента в черновик заявки через ORM
- Просмотр заявки через ORM
- Логическое удаление заявки реализовано через SQL UPDATE запрос

### Бизнес-логика
- При отсутствии заявки в статусе черновик у пользователя, она создается при добавлении компонента
- Если черновик существует, компонент добавляется в него
- Удаленные заявки не отображаются
- У каждого пользователя не более одной заявки в статусе черновик

### Docker
- Настроен docker-compose с PostgreSQL, Minio, Adminer
- PostgreSQL доступен на порту 5432
- Adminer доступен на порту 8082

## Лабораторная работа 3

### REST API
- Все методы API размещены по пути `/api`
- Реализованы методы согласно REST принципам

### Домен компонентов сервера
- `GET /api/server-components` - список компонентов с фильтрацией по наименованию
- `GET /api/server-components/{id}` - получение одного компонента
- `POST /api/server-components` - создание компонента
- `PUT /api/server-components/{id}` - обновление компонента
- `DELETE /api/server-components/{id}` - удаление компонента (включая изображение из Minio)
- `POST /api/server-components/{id}/image` - загрузка изображения компонента
- `POST /api/server-components/{componentId}/add-to-draft` - добавление компонента в черновик

### Домен заявок времени отклика
- `GET /api/ping-time/cart-icon` - получение информации иконки корзины (id черновика и количество)
- `GET /api/ping-time` - список заявок с фильтрацией по статусу и диапазону даты формирования, поддержка пагинации
- `GET /api/ping-time/{id}` - получение одной заявки с услугами
- `PUT /api/ping-time/{id}` - обновление полей заявки
- `PUT /api/ping-time/{id}/form` - формирование заявки создателем
- `PUT /api/ping-time/{id}/moderate` - завершение/отклонение заявки модератором
- `DELETE /api/ping-time/{id}` - логическое удаление заявки

### Домен связи многие-ко-многим
- `PUT /api/ping-time/{requestId}/items/{componentId}` - обновление количества компонента в заявке
- `DELETE /api/ping-time/{requestId}/items/{componentId}` - удаление компонента из заявки

### Домен пользователей
- `POST /api/users/register` - регистрация нового пользователя
- `GET /api/users/me` - получение профиля текущего пользователя
- `PUT /api/users/me` - обновление профиля пользователя

### Бизнес-логика
- Статусы нельзя менять с любого на любой: создатель удаляет и формирует черновик, модератор отклоняет и завершает сформированную заявку
- При формировании заявки происходит проверка на обязательные поля
- При завершении заявки рассчитывается общее время отклика по формуле
- Системные поля (id, статусы, создатель, модератор, даты) вычисляются на бэкенде
- Записи в статусе удален на клиент не передаются
- Фильтрация заявок по диапазону даты формирования и статусу
- Для списка заявок выводится результат или вычисляемое поле количества записей м-м с рассчитанным результатом

### Swagger
- Настроена документация API через SpringDoc OpenAPI
- Доступна по адресу `/swagger-ui.html`
- Все методы задокументированы с описаниями

### Minio интеграция
- Загрузка изображений в Minio при создании/обновлении компонента
- Генерация presigned URL для доступа к изображениям
- Удаление изображений при удалении компонента
- Название изображения генерируется на латинице

### Singleton функция
- Реализована функция получения текущего пользователя через SecurityContext
- Пользователь определяется из JWT токена

## Лабораторная работа 4

### Аутентификация и авторизация
- Реализована аутентификация через JWT токены
- JWT токены хранятся в HTTP-only cookies
- Реализован refresh token механизм
- Токены обновления также хранятся в cookies

### Redis
- Настроена интеграция с Redis для хранения черного списка токенов
- При выходе из системы JWT токен добавляется в черный список
- Проверка токена на наличие в черном списке при каждом запросе
- Docker-compose включает Redis, Redis Insight и Redis Commander

### Безопасность
- Настроена Spring Security с JWT фильтром
- Реализована проверка прав доступа через роли (USER, MODERATOR)
- Без авторизации доступно только чтение данных (GET запросы)
- С авторизацией доступны методы пользователя
- Для модератора доступны все методы, включая модерацию заявок
- Проверка isModerator в сервисном слое для методов модерации

### Автозаполнение пользователя
- При создании новой заявки автоматически указывается текущий пользователь
- Дата создания устанавливается автоматически
- Статус устанавливается в DRAFT

### API методы аутентификации
- `POST /api/auth/login` - аутентификация пользователя, установка JWT в cookies
- `POST /api/auth/logout` - выход из системы, добавление JWT в черный список
- `POST /api/auth/refresh` - обновление JWT токена

### CORS
- Настроен CORS для работы с фронтендом
- Разрешены запросы с указанных доменов
- Поддержка credentials для cookies

## Дополнительное задание

### Индексы в БД
- Реализована конфигурация для управления использованием индексов
- Настроен флаг `app.index.enabled` в application.properties
- При отключении индексов можно сравнить производительность запросов

### Пагинация
- Реализована пагинация для списка заявок времени отклика
- Метод `GET /api/ping-time` поддерживает параметры `page` и `size`
- Поддержка сортировки через параметры `sortBy` и `sortDir`
- Возвращается объект с метаданными пагинации: totalElements, totalPages, currentPage, pageSize, hasNext, hasPrevious

## Технологический стек

- Kotlin 2.0.20
- Spring Boot 3.3.5
- Spring Data JPA
- PostgreSQL 15
- Minio для хранения файлов
- Redis для черного списка токенов
- JWT для аутентификации
- Thymeleaf для шаблонизации
- SpringDoc OpenAPI для документации API
- Docker Compose для развертывания инфраструктуры

## Структура проекта

- `controller/` - REST контроллеры и контроллеры представлений
- `service/` - бизнес-логика приложения
- `domain/model/` - сущности базы данных
- `domain/repository/` - репозитории для работы с БД
- `infrastructure/dto/` - DTO для передачи данных
- `config/` - конфигурационные классы
- `resources/templates/` - HTML шаблоны
- `resources/static/` - статические ресурсы (CSS, изображения)
